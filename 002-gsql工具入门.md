## 002-gsql工具入门

gsql是openGauss提供在命令行下运行的数据库连接工具，可以通过此工具连接服务器并对其进行操作和维护，除了具备操作数据库的基本功能，gsql还提供了若干高级特性，便于用户使用。



### 连接数据库

##### 1.确认连接信息

以操作系统用户omm登录数据库主节点。

使用以下命令查询openGauss各实例情况

```shell
gs_ctl query -D 数据库实例目录
```

![image-20230727121711904](http://foolcorn-image.oss-cn-shenzhen.aliyuncs.com/img/image-20230727121711904.png)



使用以下命令确认数据库的端口号，默认是5432

```shell
cat 数据库实例目录/postgresql.conf | grep port
```

![image-20230727122154942](http://foolcorn-image.oss-cn-shenzhen.aliyuncs.com/img/image-20230727122154942.png)



##### 2.使用gsql连接数据库

在linux下创建omm用户(openGauss默认名为omm的用户为数据库的管理员)

赋予omm访问opengauss目录的权限

chmod -R omm /opt/xxxx

连接数据库

```shell
gsql -d postgres -p 5432
gsql -d "host=127.0.0.1 port=8000 dbname=postgres user=omm password=xxxx" #也可以用该命令
```

omm用户是管理员用户，因此系统显示“DBNAME=#”。若使用普通用户身份登录和连接数据库，系统显示“DBNAME=>”。

建议登录后修改密码：

```
 ALTER ROLE omm IDENTIFIED BY 'Mypwd123' REPLACE 'XuanYuan@2012';
```



##### 3.连接参数

| 参数                    | 参数说明                                                     | 取值范围                                                     |
| :---------------------- | :----------------------------------------------------------- | :----------------------------------------------------------- |
| -h, --host=HOSTNAME     | 指定正在运行服务器的主机名或者Unix域套接字的路径。           | 如果省略主机名，gsql将通过Unix域套接字与本地主机的服务器相联，或者在没有Unix域套接字的机器上，通过TCP/IP与localhost连接。 |
| -p, --port=PORT         | 指定数据库服务器的端口号。可以通过port参数修改默认端口号。   | 默认为5432。                                                 |
| -U, --username=USERNAME | 指定连接数据库的用户。说明：通过该参数指定用户连接数据库时，需要同时提供用户密码用以身份验证。您可以通过交换方式输入密码，或者通过-W参数指定密码。用户名中包含有字符$，需要在字符$前增加转义字符才可成功连接数据库。 | 字符串。默认使用与当前操作系统用户同名的用户。               |
| -W, --password=PASSWORD | 当使用-U参数连接远端数据库时，可通过该选项指定密码。说明：数据库主节点所在服务器后连接本地数据库主节点实例时，默认使用trust连接，会忽略此参数。用户密码中包含特殊字符“\”和“`”时，需要增加转义字符才可成功连接数据库。如果用户未输入该参数，但是数据库连接需要用户密码，这时将出现交互式输入，请用户输入当前连接的密码。该密码最长长度为999字节，受限于GUC参数password_max_length的最大值。 | 符合密码复杂度要求。                                         |



### 执行SQL

gsql支持交互式地执行SQL，也支持识别SQL脚本

具体的SQL教程和语法详见005-数据库基础入门



### 变量

##### 定义变量

```
openGauss=# \set value_name value
```

- 变量只是简单的名称/值对，这里的值可以是任意长度。
- 变量名称必须由字母（包括非拉丁字母）、数字和下划线组成，且对大小写敏感。
- 如果使用\set varname的格式（不带第二个参数），则只是设置这个变量而没有给变量赋值。
- 可以使用不带参数的\set来显示所有变量的值。

##### 查看变量

```
openGauss=# \echo :value_name
```

如果涉及到引用变量的值就需要在变量名之前加  ':'

##### 删除变量

```
openGauss=# \unset value_name
```

##### 预定义特殊变量

| 变量              | 变量说明                                                     |
| ----------------- | ------------------------------------------------------------ |
| DBNAME            | 当前连接的数据库的名称。每次连接数据库时都会被重新设置。     |
| ECHO              | 如果设置为all，只显示查询信息。设置为all等效于使用gsql连接数据库时指定-a参数。如果设置为queries，显示命令行和查询信息。等效于使用gsql连接数据库时指定-e参数。 |
| ECHO_HIDDEN       | 当使用元命令查询数据库信息（例如\dg）时，此变量的取值决定了查询的行为：设置为on，先显示元命令实际调用的查询语句，然后显示查询结果。等效于使用gsql连接数据库时指定-E参数。设置为off，则只显示查询结果。设置为noexec，则只显示查询信息，不执行查询操作。 |
| ENCODING          | 当前客户端的字符集编码。                                     |
| FETCH_COUNT       | 如果该变量的值为大于0的整数，假设为n，则执行SELECT语句时每次从结果集中取n行到缓存并显示到屏幕。如果不设置此变量，或设置的值小于等于0，则执行SELECT语句时一次性把结果都取到缓存。说明：设置合理的变量值，将减少内存使用量。一般来说，设为100到1000之间的值比较合理。 |
| HOST              | 已连接的数据库主机名称。                                     |
| IGNOREEOF         | 若设置此变量为数值，假设为10，则在gsql中输入的前9次EOF字符（通常是Ctrl+D组合键）都会被忽略，在第10次按Ctrl+D才能退出gsql程序。若设置此变量为非数值，则缺省为10。若删除此变量，则向交互的gsql会话发送一个EOF终止应用。 |
| LASTOID           | 最后影响的oid值，即为从一条INSERT或lo_import命令返回的值。此变量只保证在下一条SQL语句的结果显示之前有效。 |
| ON_ERROR_ROLLBACK | 如果是on，当一个事务块里的语句产生错误的时候，这个错误将被忽略而事务继续。如果是interactive，这样的错误只是在交互的会话里忽略。如果是off（缺省），事务块里一个语句生成的错误将会回滚整个事务。on_error_rollback-on模式是通过在一个事务块的每个命令前隐含地发出一个SAVEPOINT的方式工作的，在发生错误的时候回滚到该事务块。 |
| ON_ERROR_STOP     | on：命令执行错误时会立即停止，在交互模式下，gsql会立即返回已执行命令的结果。off（缺省）：命令执行错误时将会跳过错误继续执行。 |
| PORT              | 正连接数据库的端口号。                                       |
| USER              | 当前用于连接的数据库用户。                                   |
| VERBOSITY         | 这个选项可以设置为值terse、default、verbose之一以控制错误报告的冗余行。terse：仅返回严重且主要的错误文本以及文本位置（一般适合于单行错误信息）。default：返回严重且主要的错误文本及其位置，还包括详细的错误细节、错误提示（可能会跨越多行）。verbose：返回所有的错误信息。 |



##### 环境变量

| 名称                       | 描述                                                         |
| :------------------------- | :----------------------------------------------------------- |
| COLUMNS                    | 如果\set columns为0，则由此参数控制wrapped格式的宽度。这个宽度用于决定在自动扩展的模式下，是否要把宽输出模式变成竖线的格式。 |
| PAGER                      | 如果查询结果无法在一页显示，它们就会被重定向到这个命令。可以用\pset命令关闭分页器。典型的是用命令more或less来实现逐页查看。缺省值是平台相关的。说明：less的文本显示，受系统环境变量LC_CTYPE影响。 |
| PSQL_EDITOR                | \e和\ef命令使用环境变量指定的编辑器。变量是按照列出的先后顺序检查的。在Unix系统上默认的编辑工具是vi。 |
| EDITOR                     |                                                              |
| VISUAL                     |                                                              |
| PSQL_EDITOR_LINENUMBER_ARG | 当\e和\ef带上一行数字参数使用时，这个变量指定的命令行参数用于向编辑器传递起始行数。像Emacs或vi这样的编辑器，这只是个加号。如果选项和行号之间需要空白，在变量的值后加一个空格。例如：`PSQL_EDITOR_LINENUMBER_ARG = '+'   PSQL_EDITOR_LINENUMBER_ARG='--line '`Unix系统默认的是+。 |
| PSQLRC                     | 用户的.gsqlrc文件的交互位置。                                |
| SHELL                      | 使用\!命令跟shell执行的命令是一样的效果。                    |
| TMPDIR                     | 存储临时文件的目录。缺省是/tmp。                             |



##### SQL代换

gsql变量的一个关键特性是可以把gsql变量替换成正规的SQL语句。此外，gsql还提供为变量更换新的别名或其他标识符等功能。使用SQL代换方式替换一个变量的值可在变量前加冒号。

```
openGauss=# \set foo 'HR.areaS'
openGauss=# select * from :foo;
 area_id |       area_name        
---------+------------------------
       4 | Middle East and Africa
       3 | Asia
       1 | Europe
       2 | Americas
(4 rows)

```



### 自定义提示符

gsql使用的提示符支持用户自定义。可以通过修改gsql预留的三个变量PROMPT1、PROMPT2、PROMPT3来改变提示符。

| 变量    | 描述                                                         |
| :------ | :----------------------------------------------------------- |
| PROMPT1 | gsql请求一个新命令时使用的正常提示符。PROMPT1的默认值为：`%/%R%#` |
| PROMPT2 | 在一个命令输入期待更多输入时（例如，查询没有用一个分号结束或者引号不完整）显示的提示符。 |
| PROMPT3 | 当执行COPY命令，并期望在终端输入数据时（例如，COPY FROM STDIN），显示提示符。 |

提示符变量的值是按实际字符显示的，但是，当设置提示符的命令中出现“%”时，变量的值根据“%”后的字符，替换为已定义的内容，已定义的提示符如下表：

##### 特殊转义提示符

| 符号        | 符号说明                                                     |
| :---------- | :----------------------------------------------------------- |
| %M          | 主机的全名（包含域名），若连接是通过Unix域套接字进行的，则全名为[local]，若Unix域套接字不是编译的缺省位置，就是[local:/dir/name]。 |
| %m          | 主机名删去第一个点后面的部分。若通过Unix域套接字连接，则为[local]。 |
| %>          | 主机正在侦听的端口号。                                       |
| %n          | 数据库会话的用户名。                                         |
| %/          | 当前数据库名称。                                             |
| %~          | 类似 %/，如果数据库是缺省数据库时输出的是波浪线~。           |
| %#          | 如果会话用户是数据库系统管理员，使用#，否则用>。             |
| %R          | 对于PROMPT1通常是“=”，如果是单行模式则是“^”，如果会话与数据库断开（如果\connect失败可能发生）则是“!”。对于PROMPT2该序列被“ -”、单引号、双引号或“$”（取决于gsql是否等待更多的输入：查询没有终止、正在一个 / ... / 注释里、正在引号或者美元符扩展里）代替。 |
| %x          | 事务状态：如果不在事务块里，则是一个空字符串。如果在事务块里，则是“*”。如果在一个失败的事务块里则是“!”。如果无法判断事务状态时为“?”（比如没有连接）。 |
| %digits     | 指定字节值的字符将被替换到该位置。                           |
| %:name      | gsql变量“name”的值。                                         |
| %command    | command的输出，类似于使用“^”替换。                           |
| %[ . . . %] | 提示可以包含终端控制字符，这些字符可以改变颜色、背景、提示文本的风格、终端窗口的标题。例如，potgres=> \set PROMPT1 '%[%033[1;33;40m%]%n@%/%R%[%033[0m%]%#'这个句式的结果是在VT100兼容的可显示彩色的终端上的一个宽体（1;）黑底黄字（33;40）。 |



### 命令参数

##### 常用参数

| 参数                             | 参数说明                                                     | 取值范围                                         |
| :------------------------------- | :----------------------------------------------------------- | :----------------------------------------------- |
| -c, --command=COMMAND            | 声明gsql要执行一条字符串命令然后退出。                       | -                                                |
| -d, --dbname=DBNAME              | 指定想要连接的数据库名称。另外，gsql允许使用扩展的DBNAME，即'postgres[ql]://[user[:password]@][netloc][:port][,...][/dbname][?param1=value1&...]'或'[key=value] [...]'形式的连接串作为DBNAME，gsql将从连接串中解析连接信息，并优先使用这些信息。 | 字符串。                                         |
| -f, --file=FILENAME              | 使用文件作为命令源而不是交互式输入。gsql将在处理完文件后结束。如果FILENAME是-（连字符），则从标准输入读取。说明：环境场景：一主一备（8U32G）。实测：读取200M数据文件时，耗时约为8分钟21秒；读取500M数据文件时，耗时约为18分41秒。建议：文件读取的时间随文件数据量逐渐增加，如果文件太大，中间异常时需要重新读取，同时会导致系统OS的IO过载，建议文件大小控制在500M左右。 | 绝对路径或相对路径，且满足操作系统路径命名规则。 |
| -l, --list                       | 列出所有可用的数据库，然后退出。                             | -                                                |
| -v, --set, --variable=NAME=VALUE | 设置gsql变量NAME为VALUE                                      | -                                                |
| -X, --no-gsqlrc                  | 不读取启动文件（系统范围的gsqlrc或者用户的~/.gsqlrc都不读取）。说明：启动文件默认为~/.gsqlrc，或通过PSQLRC环境变量指定。 | -                                                |
| -1 ("one"), --single-transaction | 当gsql使用-f选项执行脚本时，会在脚本的开头和结尾分别加上START TRANSACTION/COMMIT用以把整个脚本当作一个事务执行。这将保证该脚本完全执行成功，或者脚本无效。说明：如果脚本中已经使用了START TRANSACTION、COMMIT、ROLLBACK，则该选项无效。 | -                                                |
| -?, --help                       | 显示关于gsql命令行参数的帮助信息然后退出。                   | -                                                |
| -V, --version                    | 打印gsql版本信息然后退出。                                   | -                                                |
| -C, --enable-client-encryption   | 当使用-C参数连接本地数据库或者远程连接数据库时，可通过该选项打开全密态数据库开关。 | -                                                |

##### 输入和输出参数

| 参数                           | 参数说明                                                     | 取值范围                                         |
| :----------------------------- | :----------------------------------------------------------- | :----------------------------------------------- |
| -a, --echo-all                 | 在读取行时向标准输出打印所有内容。注意：使用此参数可能会暴露部分SQL语句中的敏感信息，如创建用户语句中的password信息等，请谨慎使用。 | -                                                |
| -e, --echo-queries             | 把所有发送给服务器的查询同时回显到标准输出。注意：使用此参数可能会暴露部分SQL语句中的敏感信息，如创建用户语句中的password信息等，请谨慎使用。 | -                                                |
| -E, --echo-hidden              | 回显由\d和其他反斜杠命令生成的实际查询。                     | -                                                |
| -k, --with-key=KEY             | 使用gsql对导入的加密文件进行解密。须知：对于本身就是shell命令中的关键字符如单引号（'）或双引号（"），Linux shell会检测输入的单引号（'）或双引号（"）是否匹配。如果不匹配，shell认为用户没有输入完毕，会一直等待用户输入，从而不会进入到gsql程序。不支持解密导入存储过程和函数。 | -                                                |
| -L, --log-file=FILENAME        | 除了正常的输出源之外，把所有查询输出记录到文件FILENAME中。注意：使用此参数可能会暴露部分SQL语句中的敏感信息，如创建用户语句中的password信息等，请谨慎使用。此参数只保留查询结果到相应文件中，主要目标是为了查询结果能够更好更准确地被其他调用者（例如自动化运维脚本）解析；而不是保留gsql运行过程中的相关日志信息。 | 绝对路径或相对路径，且满足操作系统路径命名规则。 |
| -m, --maintenance              | 允许在两阶段事务恢复期间连接openGauss。说明：该选项是一个开发选项，禁止用户使用，只限专业技术人员使用，功能是：使用该选项时，gsql可以连接到备机，用于校验主备机数据的一致性。 | -                                                |
| -n, --no-libedit               | 关闭命令行编辑。                                             | -                                                |
| -o, --output=FILENAME          | 将所有查询输出重定向到文件FILENAME。                         | 绝对路径或相对路径，且满足操作系统路径命名规则。 |
| -q, --quiet                    | 安静模式，执行时不会打印出额外信息。                         | 缺省时gsql将打印许多其他输出信息。               |
| -s, --single-step              | 单步模式运行。意味着每个查询在发往服务器之前都要提示用户，用这个选项也可以取消执行。此选项主要用于调试脚本。注意：使用此参数可能会暴露部分SQL语句中的敏感信息，如创建用户语句中的password信息等，请谨慎使用。 | -                                                |
| -S, --single-line              | 单行运行模式，这时每个命令都将由换行符结束，像分号那样。     | -                                                |
| -C, --enable-client-encryption | 当使用-C参数连接本地数据库或者远程连接数据库时，可通过该选项打开全密态数据库开关。 | -                                                |



##### 输出格式参数

| 参数                          | 参数说明                                                     | 取值范围             |
| :---------------------------- | :----------------------------------------------------------- | :------------------- |
| -A, --no-align                | 切换为非对齐输出模式。                                       | 缺省为对齐输出模式。 |
| -F, --field-separator=STRING  | 设置域分隔符（默认为“\|”）。                                 | -                    |
| -H, --html                    | 打开HTML格式输出。                                           | -                    |
| -P, --pset=VAR[=ARG]          | 在命令行上以\pset的风格设置打印选项。说明：这里必须用等号而不是空格分隔名称和值。例如，把输出格式设置为LaTeX，可以键入-P format=latex | -                    |
| -R, --record-separator=STRING | 设置记录分隔符。                                             | -                    |
| -r                            | 开启在客户端操作中可以进行编辑的模式。                       | 缺省为关闭。         |
| -t, --tuples-only             | 只打印行。                                                   | -                    |
| -T, --table-attr=TEXT         | 允许声明放在HTML table标签里的选项。使用时请搭配参数“-H,--html”，指定为HTML格式输出。 | -                    |
| -x, --expanded                | 打开扩展表格式模式。                                         | -                    |
| -z, --field-separator-zero    | 设置非对齐输出模式的域分隔符为空。使用时请搭配参数“-A, --no-align”，指定为非对齐输出模式。 | -                    |
| -0, --record-separator-zero   | 设置非对齐输出模式的记录分隔符为空。使用时请搭配参数“-A, --no-align”，指定为非对齐输出模式。 | -                    |
| -2, --pipeline                | 使用管道传输密码，禁止在终端使用，必须和-c或者-f参数一起使用。 | -                    |
| -g,                           | 打印来自文件的所有SQL。                                      | -                    |





### gsql元命令

- 一个gsql元命令的格式是反斜杠后面紧跟一个动词，然后是任意参数。参数命令动词和其他参数以任意个空白字符间隔。
- 要在参数里面包含空白，必须用单引号把它引起来。要在这样的参数里包含单引号，可以在前面加一个反斜杠。任何包含在单引号里的内容都会被进一步进行类似C语言的替换：\n（新行）、\t（制表符）、\b（退格）、\r（回车）、\f（换页）、\digits（八进制表示的字符）、\xdigits（十六进制表示的字符）。
- ““包围的内容被当做一个命令行传入shell。该命令的输出（删除了结尾的新行）被当做参数值。
- 如果不带引号的参数以冒号（:）开头，它会被当做一个gsql变量，并且该变量的值最终会成为真正的参数值。
- 有些命令以一个SQL标识的名称（比如一个表）为参数。这些参数遵循SQL语法关于双引号的规则：不带双引号的标识强制转换成小写，而双引号保护字母不进行大小写转换，并且允许在标识符中使用空白。在双引号中，成对的双引号在结果名称中分析成一个双引号。比如，FOO“BAR”BAZ解析成fooBARbaz；而“A weird”“name”解析成“A weird”name。
- 对参数的分析在遇到另一个不带引号的反斜杠时停止。这里会认为是一个新的元命令的开始。特殊的双反斜杠序列（\\）标识参数的结尾并将继续分析后面的SQL语句（如果存在）。这样SQL和gsql命令可以自由的在一行里面混合。但是在任何情况下，一条元命令的参数不能延续超过行尾。



##### 一般元命令

| 参数                      | 参数说明                                                     | 取值范围                                                     |
| :------------------------ | :----------------------------------------------------------- | :----------------------------------------------------------- |
| \copyright                | 显示openGauss的版本和版权信息。                              | -                                                            |
| \g [FILE] or ;            | 执行查询（并将结果发送到文件或管道）。                       | -                                                            |
| \h(\help) [NAME]          | 给出指定SQL语句的语法帮助。                                  | 如果没有给出NAME，gsql将列出可获得帮助的所有命令。如果NAME是一个星号（*），则显示所有SQL语句的语法帮助。 |
| \parallel [on [num]\|off] | 控制并发执行开关。on：打开控制并发执行开关，且最大并发数为num。off：关闭控制并发执行开关。说明：不支持事务中开启并发执行以及并发中开启事务。不支持\d这类元命令的并发。并发select返回结果混乱问题，此为客户可接受，core、进程停止响应不可接受。不推荐在并发中使用set语句，否则导致结果与预期不一致。不支持创建临时表！如需使用临时表，需要在开启parallel之前创建好，并在parallel内部使用。parallel内部不允许创建临时表。\parallel执行时最多会启动num个独立的gsql进程连接服务器。\parallel中所有作业的持续时间不能超过session_timeout，否则可能会导致并发执行过程中断连。在\parallel on 之后一条或多条命令，会等到\parallel off执行后才会执行，因而，每个\parallel on需对应一个\parallel off，否则会导致\parallel on之后的命令无法执行。 | num的默认值：1024。须知：服务器能接受的最大连接数受max_connection及当前已有连接数限制。设置num时请考虑服务器当前可接受的实际连接数合理指定。 |
| \q                        | 退出gsql程序。在一个脚本文件里，只在脚本终止的时候执行。     | -                                                            |



##### 查询缓存元命令

| 参数                  | 参数说明                                                     |
| :-------------------- | :----------------------------------------------------------- |
| \e [FILE] [LINE]      | 使用外部编辑器编辑查询缓冲区（或者文件）。                   |
| \ef [FUNCNAME [LINE]] | 使用外部编辑器编辑函数定义。如果指定了LINE（即行号），则光标会指到函数体的指定行。 |
| \p                    | 打印当前查询缓冲区到标准输出。                               |
| \r                    | 重置（或清空）查询缓冲区。                                   |
| \w FILE               | 将当前查询缓冲区输出到文件。                                 |



##### 输入、输出元命令

| 参数                                                         | 参数说明                                                     |
| :----------------------------------------------------------- | :----------------------------------------------------------- |
| \copy { table [ ( column_list ) ] \| ( query ) } { from \| to } { filename \| stdin \| stdout \| pstdin \| pstdout } [ with ] [ binary ] [ oids ] [ delimiter [ as ] 'character' ] [ null [ as ] 'string' ] [ csv [ header ] [ quote [ as ] 'character' ] [ escape [ as ] 'character' ] [ force quote column_list \| * ] [ force not null column_list ] ][parallel integer] | 在任何psql客户端登录数据库成功后可以执行导入导出数据， 这是一个运行SQL COPY命令的操作，但不是读取或写入指定文件的服务器，而是读取或写入文件，并在服务器和本地文件系统之间路由数据。 这意味着文件的可访问性和权限是本地用户的权限，而不是服务器的权限，并且不需要数据库初始化用户权限。说明：\COPY只适合小批量，格式良好的数据导入，不会对非法字符进行预处理，也无容错能力。导入数据应优先选择COPY。\COPY 可以指定数据导入时的客户端数量，从而实现数据文件的并行导入，目前并发数范围为[1, 8]。\COPY并行导入目前存在以下约束：临时表的并行导入不支持、在事务内的并行导入不支持、对二进制文件的并行导入不支持、数据导入支持AES128加密时不支持。在这些情况下，即使指定了parallel参数，仍然会走非并行流程。 |
| \echo [STRING]                                               | 把字符串写到标准输出。                                       |
| \i FILE                                                      | 从文件FILE中读取内容，并将其当作输入，执行查询。             |
| \i+ FILE KEY                                                 | 执行加密文件中的命令。                                       |
| \ir FILE                                                     | 和\i类似，只是相对于存放当前脚本的路径。                     |
| \ir+ FILE KEY                                                | 和\i+类似，只是相对于存放当前脚本的路径。                    |
| \o [FILE]                                                    | 把所有的查询结果发送到文件里。                               |
| \qecho [STRING]                                              | 把字符串写到查询结果输出流里。                               |



##### 显示信息元命令

| 参数                                                         | 参数说明                                                     | 取值范围                                                     | 示例                                                         |
| :----------------------------------------------------------- | :----------------------------------------------------------- | :----------------------------------------------------------- | :----------------------------------------------------------- |
| \d[S+]                                                       | 列出当前search_path中模式下所有的表、视图和序列。当search_path中不同模式存在同名对象时，只显示search_path中位置靠前模式下的同名对象。 | -                                                            | 列出当前search_path中模式下所有的表、视图和序列。`openGauss=# \d` |
| \d[S+] NAME                                                  | 列出指定表、视图和索引的结构。                               | -                                                            | 假设存在表a，列出指定表a的结构。`openGauss=#  \dtable+ a`    |
| \d+ [PATTERN]                                                | 列出所有表、视图和索引。                                     | 如果声明了PATTERN，只显示名称匹配PATTERN的表、视图和索引。   | 列出所有名称以f开头的表、视图和索引。`openGauss=# \d+ f*`    |
| \da[S] [PATTERN]                                             | 列出所有可用的聚集函数以及它们操作的数据类型和返回值类型。   | 如果声明了PATTERN，只显示名称匹配PATTERN的聚集函数。         | 列出所有名称以f开头可用的聚集函数以及它们操作的数据类型和返回值类型。`openGauss=# \da f*` |
| \db[+] [PATTERN]                                             | 列出所有可用的表空间。                                       | 如果声明了PATTERN，只显示名称匹配PATTERN的表空间。           | 列出所有名称以p开头的可用表空间。`openGauss=# \db p*`        |
| \dc[S+] [PATTERN]                                            | 列出所有字符集之间的可用转换。                               | 如果声明了PATTERN，只显示名称匹配PATTERN的转换。             | 列出所有字符集之间的可用转换。`openGauss=# \dc *`            |
| \dC[+] [PATTERN]                                             | 列出所有类型转换。                                           | 如果声明了PATTERN，只显示名称匹配PATTERN的转换。             | 列出所有名称以c开头的类型转换。`openGauss=# \dC c*`          |
| \dd[S] [PATTERN]                                             | 显示所有匹配PATTERN的描述。                                  | 如果没有给出参数，则显示所有可视对象。“对象”包括：聚集、函数、操作符、类型、关系（表、视图、索引、序列、大对象）、规则。 | 列出所有可视对象。`openGauss=# \dd`                          |
| \ddp [PATTERN]                                               | 显示所有默认的使用权限。                                     | 如果指定了PATTERN，只显示名称匹配PATTERN的使用权限。         | 列出所有默认的使用权限。`openGauss=# \ddp`                   |
| \dD[S+] [PATTERN]                                            | 列出所有可用域。                                             | 如果声明了PATTERN，只显示名称匹配PATTERN的域。               | 列出所有可用域。`openGauss=# \dD`                            |
| \ded[+] [PATTERN]                                            | 列出所有的Data Source对象。                                  | 如果声明了PATTERN，只显示名称匹配PATTERN的对象。             | 列出所有的Data Source对象。`openGauss=# \ded`                |
| \det[+] [PATTERN]                                            | 列出所有的外部表。                                           | 如果声明了PATTERN，只显示名称匹配PATTERN的表。               | 列出所有的外部表。`openGauss=# \det`                         |
| \des[+] [PATTERN]                                            | 列出所有的外部服务器。                                       | 如果声明了PATTERN，只显示名称匹配PATTERN的服务器。           | 列出所有的外部服务器。`openGauss=# \des`                     |
| \deu[+] [PATTERN]                                            | 列出用户映射信息。                                           | 如果声明了PATTERN，只显示名称匹配PATTERN的信息。             | 列出用户映射信息。`openGauss=# \deu`                         |
| \dew[+] [PATTERN]                                            | 列出封装的外部数据。                                         | 如果声明了PATTERN，只显示名称匹配PATTERN的数据。             | 列出封装的外部数据。`openGauss=# \dew`                       |
| \df[antw][S+] [PATTERN]                                      | 列出所有可用函数以及它们的参数和返回的数据类型。a代表聚集函数，n代表普通函数，t代表触发器，w代表窗口函数。 | 如果声明了PATTERN，只显示名称匹配PATTERN的函数。             | 列出所有可用函数以及它们的参数和返回的数据类型。`openGauss=# \df` |
| \dF[+] [PATTERN]                                             | 列出所有的文本搜索配置信息。                                 | 如果声明了PATTERN，只显示名称匹配PATTERN的配置信息。         | 列出所有的文本搜索配置信息。`openGauss=# \dF+`               |
| \dFd[+] [PATTERN]                                            | 列出所有的文本搜索字典。                                     | 如果声明了PATTERN，只显示名称匹配PATTERN的字典。             | 列出所有的文本搜索字典。`openGauss=# \dFd`                   |
| \dFp[+] [PATTERN]                                            | 列出所有的文本搜索分析器。                                   | 如果声明了PATTERN，只显示名称匹配PATTERN的分析器。           | 列出所有的文本搜索分析器。`openGauss=# \dFp`                 |
| \dFt[+] [PATTERN]                                            | 列出所有的文本搜索模板。                                     | 如果声明了PATTERN，只显示名称匹配PATTERN的模板。             | 列出所有的文本搜索模板。`openGauss=# \dFt`                   |
| \dg[+] [PATTERN]                                             | 列出所有数据库角色。说明：因为用户和群组的概念被统一为角色，所以这个命令等价于\du。为了和以前兼容，所以保留两个命令。 | 如果指定了PATTERN，只显示名称匹配PATTERN的角色。             | 列出名称为‘j_e’所有数据库角色。`openGauss=# \dg j?e`         |
| \dl                                                          | \lo_list的别名，显示一个大对象的列表。                       | -                                                            | 列出所有的大对象。`openGauss=# \dl`                          |
| \dL[S+] [PATTERN]                                            | 列出可用的程序语言。                                         | 如果指定了PATTERN，只列出名称匹配PATTERN的语言。             | 列出可用的程序语言。`openGauss=# \dL`                        |
| \dn[S+] [PATTERN]                                            | 列出物化视图。                                               | 如果指定了PATTERN，只列出名称匹配PATTERN的物化视图。         | 列出物化视图。`openGauss=#  \dm`                             |
| \dn[S+] [PATTERN]                                            | 列出所有的模式（名称空间）。                                 | 如果声明了PATTERN，只列出名称匹配PATTERN的模式名。缺省时，只列出用户创建的模式。 | 列出所有名称以d开头的模式以及相关信息。`openGauss=#  \dn+ d*` |
| \do[S] [PATTERN]                                             | 列出所有可用的操作符以及它们的操作数和返回的数据类型。       | 如果声明了PATTERN，只列出名称匹配PATTERN的操作符。缺省时，只列出用户创建的操作符。 | 列出所有可用的操作符以及它们的操作数和返回的数据类型。`openGauss=# \do` |
| \dO[S+] [PATTERN]                                            | 列出排序规则。                                               | 如果声明了PATTERN，只列出名称匹配PATTERN的规则。缺省时，只列出用户创建的规则。 | 列出排序规则。`openGauss=# \dO`                              |
| \dp [PATTERN]                                                | 列出一列可用的表、视图以及相关的权限信息。\dp显示结果如下：`rolename=xxxx/yyyy  --赋予一个角色的权限``=xxxx/yyyy  --赋予public的权限 `xxxx表示赋予的权限，yyyy表示授予这个权限的角色。权限的参数说明请参见[表 权限的参数说明](https://docs.opengauss.org/zh/docs/3.0.0/docs/Toolreference/gsql.html#zh-cn_topic_0237152146_zh-cn_topic_0059778645_t9b9f37d7c1c54a7893307344083e644e)。 | 如果指定了PATTERN，只列出名称匹配PATTERN的表、视图。         | 列出一列可用的表、视图以及相关的权限信息。`openGauss=# \dp`  |
| \drds [PATTERN1 [PATTERN2]]                                  | 列出所有修改过的配置参数。这些设置可以是针对角色的、针对数据库的或者同时针对两者的。PATTERN1和PATTERN2表示要列出的角色PATTERN和数据库PATTERN。 | 如果声明了PATTERN，只列出名称匹配PATTERN的规则。缺省或指定*时，则会列出所有设置。 | 列出postgres数据库所有修改过的配置参数。`openGauss=# \drds * postgres` |
| \dT[S+] [PATTERN]                                            | 列出所有的数据类型。                                         | 如果指定了PATTERN，只列出名称匹配PATTERN的类型。             | 列出所有的数据类型。`openGauss=# \dT`                        |
| \du[+] [PATTERN]                                             | 列出所有数据库角色。说明：因为用户和群组的概念被统一为角色，所以这个命令等价于\dg。为了和以前兼容，所以保留两个命令。 | 如果指定了PATTERN，则只列出名称匹配PATTERN的角色。           | 列出所有数据库角色。`openGauss=# \du`                        |
| \dE[S+] [PATTERN]\di[S+] [PATTERN]\ds[S+] [PATTERN]\dt[S+] [PATTERN]\dv[S+] [PATTERN] | 这一组命令，字母E、i、s、t和v分别代表着外部表、索引、序列、表和视图。可以以任意顺序指定其中一个或者它们的组合来列出这些对象。例如：\dit列出所有的索引和表。在命令名称后面追加+，则每一个对象的物理尺寸以及相关的描述也会被列出。 | 如果指定了PATTERN，只列出名称匹配该PATTERN的对象。默认情况下只会显示用户创建的对象。通过PATTERN或者S修饰符可以把系统对象包括在内。 | 列出所有的索引和视图。`openGauss=# \div`                     |
| \dx[+] [PATTERN]                                             | 列出安装数据库的扩展信息。                                   | 如果指定了PATTERN，则只列出名称匹配PATTERN的扩展信息。       | 列出安装数据库的扩展信息。`openGauss=# \dx`                  |
| \l[+]                                                        | 列出服务器上所有数据库的名称、所有者、字符集编码以及使用权限。 | -                                                            | 列出服务器上所有数据库的名称、所有者、字符集编码以及使用权限。`openGauss=#  \l` |
| \sf[+] FUNCNAME                                              | 显示函数的定义。说明：对于带圆括号的函数名，需要在函数名两端添加双引号，并且在双引号后面加上参数类型列表。参数类型列表两端添加圆括号。 | -                                                            | 假设存在函数function_a和函数名带圆括号的函数func()name，列出函数的定义。`openGauss=# \sf function_a openGauss=# \sf  "func()name"(argtype1, argtype2)` |
| \z [PATTERN]                                                 | 列出数据库中所有表、视图和序列以及它们相关的访问特权。       | 如果给出任何pattern ，则被当成一个正则表达式，只显示匹配的表、视图、序列。 | 列出数据库中所有表、视图和序列以及它们相关的访问特权。`openGauss=# \z` |



##### 权限参数

| 参数 | 参数说明                                                     |
| :--- | :----------------------------------------------------------- |
| r    | SELECT：允许对指定的表、视图读取数据。                       |
| w    | UPDATE：允许对指定表更新字段。                               |
| a    | INSERT：允许对指定表插入数据。                               |
| d    | DELETE：允许删除指定表中的数据。                             |
| D    | TRUNCATE：允许清理指定表中的数据。                           |
| x    | REFERENCES：允许创建外键约束。由于当前不支持外键，所以该参数暂不生效。 |
| t    | TRIGGER：允许在指定表上创建触发器。                          |
| X    | EXECUTE：允许使用指定的函数以及利用这些函数实现的操作符。    |
| U    | USAGE：对于过程语言，允许用户在创建函数时，指定过程语言。对于模式，允许访问包含在指定模式中的对象。对于序列，允许使用nextval函数。 |
| C    | CREATE：对于数据库，允许在该数据库里创建新的模式。对于模式，允许在该模式中创建新的对象。对于表空间，允许在其中创建表以及允许创建数据库和模式的时候把该表空间指定为其缺省表空间。 |
| c    | CONNECT：允许用户连接到指定的数据库。                        |
| T    | TEMPORARY：允许创建临时表。                                  |
| A    | ALTER：允许用户修改指定对象的属性。                          |
| P    | DROP：允许用户删除指定的对象。                               |
| m    | COMMENT：允许用户定义或修改指定对象的注释。                  |
| i    | INDEX：允许用户在指定表上创建索引。                          |
| v    | VACUUM：允许用户对指定的表执行ANALYZE和VACUUM操作。          |
| *    | 给前面权限的授权选项。                                       |



##### 格式化元命令

| 参数               | 参数说明                                                     |
| :----------------- | :----------------------------------------------------------- |
| \a                 | 对齐模式和非对齐模式之间的切换。                             |
| \C [STRING]        | 把正在打印的表的标题设置为一个查询的结果或者取消这样的设置。 |
| \f [STRING]        | 对于不对齐的查询输出，显示或者设置域分隔符。                 |
| \H                 | 若当前模式为文本格式，则切换为HTML输出格式。若当前模式为HTML格式，则切换回文本格式。 |
| \pset NAME [VALUE] | 设置影响查询结果表输出的选项。NAME的取值见[表 可调节的打印选项](https://docs.opengauss.org/zh/docs/3.0.0/docs/Toolreference/gsql.html#zh-cn_topic_0237152146_zh-cn_topic_0059778645_zh-cn_topic_0058968158_table22053343)。 |
| \t [on\|off]       | 切换输出的字段名的信息和行计数脚注。                         |
| \T [STRING]        | 指定在使用HTML输出格式时放在table标签里的属性。如果参数为空，不设置。 |
| \x [on\|off\|auto] | 切换扩展行格式。                                             |



##### 可调节的打印选项

| 选项                  | 选项说明                                                     | 取值范围                                                     |
| :-------------------- | :----------------------------------------------------------- | :----------------------------------------------------------- |
| border                | value必须是一个数字。通常这个数字越大，表的边界就越宽线就越多，但是这个取决于特定的格式。 | 在HTML格式下，取值范围为大于0的整数。在其他格式下，取值范围：0：无边框1：内部分隔线2：台架 |
| expanded (或x)        | 在正常和扩展格式之间切换。                                   | 当打开扩展格式时，查询结果用两列显示，字段名称在左、数据在右。这个模式在数据无法放进通常的“水平”模式的屏幕时很有用。在正常格式下，当查询输出的格式比屏幕宽时，用扩展格式。正常格式只对aligned和wrapped格式有用。 |
| fieldsep              | 声明域分隔符来实现非对齐输出。这样就可以创建其他程序希望的制表符或逗号分隔的输出。要设置制表符域分隔符，键入\pset fieldsep '\t'。缺省域分隔符是 '\|' (竖条符)。 | -                                                            |
| fieldsep_zero         | 声明域分隔符来实现非对齐输出到零字节。                       | -                                                            |
| footer                | 用来切换脚注。                                               | -                                                            |
| format                | 设置输出格式。允许使用唯一缩写（这意味着一个字母就够了）。   | 取值范围：unaligned：写一行的所有列在一条直线上中，当前活动字段分隔符分隔。aligned：此格式是标准的，可读性最好的文本输出。wrapped：类似aligned，但是包装跨行的宽数据值，使其适应目标字段的宽度输出。html：把表输出为可用于文档里的对应标记语言。输出不是完整的文档。latex：把表输出为可用于文档里的对应标记语言。输出不是完整的文档。troff-ms：把表输出为可用于文档里的对应标记语言。输出不是完整的文档。 |
| null                  | 打印一个字符串，用来代替一个null值。                         | 缺省是什么都不打印，这样很容易和空字符串混淆。               |
| numericlocale         | 切换分隔小数点左边的数值的区域相关的分组符号。               | on：显示指定的分隔符。off：不显示分隔符。忽略此参数，显示默认的分隔符。 |
| pager                 | 控制查询和gsql帮助输出的分页器。如果设置了环境变量PAGER，输出将被指向到指定程序，否则使用系统缺省。 | on：当输出到终端且不适合屏幕显示时，使用分页器。off：不使用分页器。always：当输出到终端无论是否符合屏幕显示时，都使用分页器。 |
| recordsep             | 声明在非对齐输出格式时的记录分隔符。                         | -                                                            |
| recordsep_zero        | 声明在非对齐输出到零字节时的记录分隔符。                     | -                                                            |
| tableattr（或T）      | 声明放在html输出格式中HTML table标签的属性（例如：cellpadding或bgcolor）。注意：这里可能不需要声明border，因为已经在\pset border里用过了。如果没有给出value，则不设置表的属性。 | -                                                            |
| title                 | 为随后打印的表设置标题。这个可以用于给输出一个描述性标签。如果没有给出value，不设置标题。 | -                                                            |
| tuples_only （或者t） | 在完全显示和只显示实际的表数据之间切换。完全显示将输出像列头、标题、各种脚注等信息。在tuples_only模式下，只显示实际的表数据。 | -                                                            |
| feedback              | 切换是否输出结果行数。                                       | -                                                            |



##### 连接元命令

| 参数                                           | 参数说明                                                     | 取值范围                         |
| :--------------------------------------------- | :----------------------------------------------------------- | :------------------------------- |
| \c[onnect] [DBNAME\|- USER\|- HOST\|- PORT\|-] | 连接到一个新的数据库（当前数据库为postgres）。当数据库名称长度超过63个字节时，默认前63个字节有效，连接到前63个字节对应的数据库，但是gsql的命令提示符中显示的数据库对象名仍为截断前的名称。说明：重新建立连接时，如果切换数据库登录用户，将可能会出现交互式输入，要求输入新用户的连接密码。该密码最长长度为999字节，受限于GUC参数password_max_length的最大值。 | -                                |
| \encoding [ENCODING]                           | 设置客户端字符编码格式。                                     | 不带参数时，显示当前的编码格式。 |
| \conninfo                                      | 输出当前连接的数据库的信息。                                 | -                                |



##### 操作系统元命令

| 参数                 | 参数说明                                                     | 取值范围                                         |
| :------------------- | :----------------------------------------------------------- | :----------------------------------------------- |
| \cd [DIR]            | 切换当前的工作目录。                                         | 绝对路径或相对路径，且满足操作系统路径命名规则。 |
| \setenv NAME [VALUE] | 设置环境变量NAME为VALUE，如果没有给出VALUE值，则不设置环境变量。 | -                                                |
| \timing [on\|off]    | 以毫秒为单位显示每条SQL语句的执行时间。                      | on表示打开显示。off表示关闭显示。                |
| \! [COMMAND]         | 返回到一个单独的Unix shell或者执行Unix命令COMMAND。          | -                                                |



##### set元命令

| 名称                     | 命令说明                                                     | 取值范围                                         |
| :----------------------- | :----------------------------------------------------------- | :----------------------------------------------- |
| \set VERBOSITY value     | 这个选项可以设置为值default， verbose，terse之一以控制错误报告的冗余行。 | value取值范围：default， verbose，terse          |
| \set ON_ERROR_STOP value | 如果设置了这个变量，脚本处理将马上停止。如果该脚本是从另外一个脚本调用的，那个脚本也会按同样的方式停止。如果最外层的脚本不是从一次交互的gsql会话中调用的而是用-f选项调用的，gsql将返回错误代码3，以示这个情况与致命错误条件的区别（错误代码为1）。 | value取值范围为：on/off，true/false，yes/no，1/0 |
| \set RETRY [retry_times] | 用于控制是否开启语句出错场景下的重试功能，参数retry_times用来指定最大重试次数，缺省值为5，取值范围为5-10。当重试功能已经开启时，再次执行\set RETRY可以关闭该功能。使用配置文件retry_errcodes.conf列举需要重试的错误码列表，该文件和gsql可执行程序位于同一级目录下。该配置文件为系统配置，非用户定义，不允许用户直接修改。当前支持以下出错场景的重试：YY001：TCP通信错误，Connection reset by peerYY002：TCP通信错误，Connection reset by peerYY003：锁超时，Lock wait timeout.../wait transaction xxx sync time exceed xxxYY004：TCP通信错误，Connection timed outYY005：SET命令发送失败，ERROR SET queryYY006：内存申请失败，memory is temporarily unavailableYY007：通信库错误，Memory allocate errorYY008：通信库错误，No data in bufferYY009：通信库错误，Close because release memoryYY010：通信库错误，TCP disconnectYY011：通信库错误，SCTP disconnectYY012：通信库错误，Stream closed by remoteYY013：通信库错误，Wait poll unknown errorYY014,YY015,53200,08006,08000,57P01,XX003,XX009等同时，出错时gsql会查询数据库节点的连接状态，当状态异常时会sleep 1分钟再进行重试，能够覆盖大部分主备切换场景下的出错重试。说明：不支持事务块中的语句错误重试；不支持通过ODBC、JDBC接口查询的出错重试；含有unlogged表的sql语句，不支持节点故障后的出错重试；gsql客户端本身出现的错误，不在重跑考虑范围之内； | retry_times取值范围为：5-10                      |



##### 大对象元命令

| 参数     | 参数说明                                                     |
| :------- | :----------------------------------------------------------- |
| \lo_list | 显示一个目前存储在该数据库里的所有openGauss大对象和提供给他们的注释。 |



###  获取帮助

连接数据库时，可以使用如下命令获取帮助信息。

```
gsql --help
```

显示如下帮助信息

```
......
Usage:
  gsql [OPTION]... [DBNAME [USERNAME]]

General options:
  -c, --command=COMMAND    run only single command (SQL or internal) and exit
  -d, --dbname=DBNAME      database name to connect to (default: "omm")
  -f, --file=FILENAME      execute commands from file, then exit
......
```

连接到数据库后，可以使用如下命令获取帮助信息。

```
help
```

显示如下帮助信息

```
You are using gsql, the command-line interface to gaussdb.
Type:  \copyright for distribution terms
       \h for help with SQL commands
       \? for help with gsql commands
       \g or terminate with semicolon to execute query
       \q to quit 
```

